# UniQOS

this is where you will find instructions on how to add and maintain this project, but mostly listen to me rant.

## Repository Overview
this project has been structured around the stm32 ecosystem while aiming to be as modular as possible without any reliance on developing within the environment generated by CubeMX/HAL. this means any generated code from CubeMX **WILL NOT** need to be and **SHOULD NOT** be edited at any point. if you do need to make changes to the .ioc file, make sure you read the CubeMX configuration guide below.

- /drivers
    any files relevant to hardware / peripheral level interactions will be found here. you will also need to run test files using make from this directory.
- /include
    store all .h project files here
- /kernel
    RTOS level interactions, task management, timing and main entry point for the OS.
- /tests
    any relevent tests you need to run will be stored here. start with test_template.c and create a copy to run any tests you need, just make sure to create a new Makefile argument and specify the file path.
- /third_party
    any external libraries not developed by the UQ Phone team is stored in this directory
- /ui
    drawing functions and display ui level files stored here.

## Flash Instructions
make sure STM32_Programmer_CLI and arm-none-eabi-gcc are installed and accessible in your PATH variables.

### running tests
MAKE BOARD=(dev or pcb) TEST=(display, modem etc..) 
*optional add -j(cpu thread-count) flag to speed up execution

### main OS
MAKE BOARD=(dev or pcb)

*arm-none-eabi-gcc version 14.2

## CubeMX Configuration
i should eventually create a script to automate this process but for now please follow these instructions if you need to make changes to the .ioc file. the relevent .ioc files are found in third_party/stm32.

- 1. these settings should already be set but double check 
        a. `Project Manager` -> `Project` -> `Application Structure` "Do not generate the main()" is ticked and `Toolchain / IDE` is set to Makefile.
        b. `Project Manager` -> `Code Generator` -> `Generate peripheral initialization as a pair of c/h files per peripheral` is ticked.

- 2. you can now make changes to the .ioc and generate the code. all files will be generated in their correct locations so you will not need to move them. after generation, if you have made any changes to the clock configurations or memory region (MPU), you will need to copy the MPU_Config and SystemClock_Config functions in third_party/stm32/Core/src and place these in your entry point files (test files and kernel). 
now go to third_party/stm32/Core/src and delete main.c. the reasoning behind this is that CubeMX does not expose the MPU_Config and SystemClock_Config configs to main.h for other files to access. this forces us to use main.c as the entry point for the project, as otherwise copying these functions out of main.c and reusing them in other files will result in a multiple definition error. while we can just rename these functions to avoid this error, i would prefer to just remove the file entirely.

- 3. go to third_party/stm32/Makefile and first delete the Core/Src/main.c def then copy all the defines in C_SOURCES and place them under STM32_BASE_SOURCES in both the drivers/Makefile and kernel/Makefile. these need to be redefined as when we use our custom Makefile it invokes the third-party Makefile after redefining C_SOURCES. the third-party Makefile uses the C_SOURCES value passed to it during the invocation, effectively replacing its own definition of C_SOURCES. 


## Hardware Components

- **STM32H7xx:** Microcontroller
- **RC7620:** Cellular Module
- **NAU88C22:** Audio Codec
- **DRV2603:** Vibration Motor Driver
- **LSM6DSVTR:** Motion sensor
- **WS2812:** RGB LED IC
- **BQ27441:** Fuel Gauge IC
- **MCP73871:** Battery Management


## Planned Task Mapping

| Task               | Priority |
| :----------------- | -------: |
| Cellular Task      |     High |
| Audio Task         |     High |
| Call State Task    |   Medium |
| Power Management   |   Medium |
| Watchdog Task      |   Medium |
| UI/Display Task    |  Low-mid |
| Input handler Task |  Low-mid |
| Logging Task       |      Low |

## Task Communication

- Queue from Input → UI
- Queue from UI → Call State
- Queue or event group from Call State → Cellular Task
- Queue from Cellular Task → Call State
- Event group or direct-to-task notification from Call State → Audio Codec Task


